'use strict';var e=require("@babel/runtime/helpers/interopRequireDefault"),r=e(require("@babel/runtime/regenerator")),n=e(require("@babel/runtime/helpers/extends")),t=require('commander'),a=require('path'),i=require("fs"),o=require("pump"),s=require('compressing'),c=require("./config/common"),l=c.project_dir,p=c.process_dir,u=c.SDK_VERSION,g=c.makeDirsSync,b=require("../miot-sdk/package.json"),m=require("../miwear-sdk/package.json"),f=require('./run-eslint').fix,d=t.version("version:"+u).usage("<packageName>").option("-t, --target [dir]","\u8f93\u51fa\u7684\u76ee\u6807\u6587\u4ef6\u5939","").option("-l, --disable-lint","\u662f\u5426\u7981\u7528eslint").option("-w, --wear","").option("-m, --enable-imagemin","\u662f\u5426\u542f\u7528\u56fe\u7247\u538b\u7f29").description("\u6253\u6210\u53d1\u5e03\u5305").parse(process.argv);function k(){var e,c,u,f,k,x,h,y,j,v,S,q,_,w,A,E,J,N,P,D,F,I,O,R;return r.default.async(function(W){for(;;)switch(W.prev=W.next){case 0:if(!((t.args||[]).length<1)){W.next=4;break}return t.outputHelp(),process.exit(1001),W.abrupt("return");case 4:if(e=t.args[0],c=a.join(l,"projects",e),u=a.join(c,"project.json"),f=!(!t.target||!t.target.length)&&t.target,k=t.enableImagemin,x=a.join(c,"build"),h=f?a.isAbsolute(f)?f:a.join(p,f):a.join(x,"publish"),g(a.dirname(h)),g(a.dirname(x)),i.existsSync(c)&&i.existsSync(u)){W.next=17;break}return console.log("invalid package path"),process.exit(1002),W.abrupt("return");case 17:if((y=JSON.parse(i.readFileSync(u).toString())).package_path==e){W.next=21;break}return console.log("invalid package path in project.json"),W.abrupt("return");case 21:if(j={min_sdk_api_level:b.api_level,package_path:e,version_code:parseInt(y.version_code||"0"),entrance_scene:y.entrance_scene||{}},d.wear&&(j.wear_min_sdk_api_level=m.api_level),y=(0,n.default)(y,j),console.log(y),y=Buffer.from(JSON.stringify(y)),v=h.endsWith(".mpkg")?h:h+".mpkg",console.log("Ready to create publish package file:"),console.log(a.relative(p,v)),S=new s.zip.Stream,q=a.join(x,"project.json"),i.writeFileSync(q,y),!k){W.next=57;break}return W.prev=33,W.next=36,r.default.awrap(require('imagemin')([a.join(c,"**/*.{jpg,JPG,jpeg,JPEG,png,gif}")],{plugins:[require('imagemin-jpegtran')(),require('imagemin-pngquant')(),require('imagemin-gifsicle')()]}));case 36:_=W.sent,w=_,A=Array.isArray(w),E=0,w=A?w:w["function"==typeof Symbol&&"function"==typeof Symbol?Symbol.iterator:"@@iterator"]();case 38:if(!A){W.next=44;break}if(!(E>=w.length)){W.next=41;break}return W.abrupt("break",52);case 41:J=w[E++],W.next=48;break;case 44:if(!(E=w.next()).done){W.next=47;break}return W.abrupt("break",52);case 47:J=E.value;case 48:N=J,i.writeFileSync(N.sourcePath,N.data);case 50:W.next=38;break;case 52:W.next=57;break;case 54:W.prev=54,W.t0=W.catch(33),console.log("imagemin error: "+W.t0);case 57:S.addEntry(q),P=i.readdirSync(c),D=Array.isArray(P),F=0,P=D?P:P["function"==typeof Symbol&&"function"==typeof Symbol?Symbol.iterator:"@@iterator"]();case 59:if(!D){W.next=65;break}if(!(F>=P.length)){W.next=62;break}return W.abrupt("break",77);case 62:I=P[F++],W.next=69;break;case 65:if(!(F=P.next()).done){W.next=68;break}return W.abrupt("break",77);case 68:I=F.value;case 69:if((O=I)&&""!=O&&"build"!=O&&"project.json"!=O&&!O.startsWith(".")){W.next=72;break}return W.abrupt("continue",75);case 72:R=a.join(c,O),console.log("compressing:"+R),S.addEntry(R);case 75:W.next=59;break;case 77:console.log("finish add compressing"),o(S,i.createWriteStream(v),function(e){e&&console.log("failed to create publish file",e),e||(console.log("Publish package file for publish is generated:"),console.log(v))});case 79:case"end":return W.stop()}},null,null,[[33,54]])}try{!(function(){if((t.args||[]).length<1)return t.outputHelp(),void process.exit(1001);var e=t.args[0],r=!t.disableLint,n=a.join(l,"projects",e);if(!i.existsSync(n))return console.log("invalid package path"),void process.exit(1002);r?f([n]).then(function(){console.log('eslint fix report'),k()}).catch(function(){console.log('eslint fix some errors, to disable add option -l. eg: npm run publish -- -l com.xiaomi.demo'),k()}):k()})()}catch(e){console.log(e)}