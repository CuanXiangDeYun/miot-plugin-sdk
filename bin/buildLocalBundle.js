'use strict';var e=require("@babel/runtime/helpers/interopRequireDefault")(require("@babel/runtime/helpers/slicedToArray"));try{require('graceful-fs').gracefulify(require('fs')),require('./local-cli/server/checkNodeVersion')(),require('./setupBabel')();var r=require('commander'),o=require('path'),i=require("fs"),n=require('colors'),t=require("./config/common"),s=t.process_dir,l=t.API_LEVEL,a=t.SDK_VERSION,c=t.IOS,u=t.ANDROID,d=t.makeDirs,p=t.parsePackageNameArg;r.version("version:"+a).option("-a, --android","android\u7248\u672c").option("-i, --ios","ios\u7248\u672c").option("-r, --reset-cache","\u6e05\u9664\u7f13\u5b58").option("-t, --target [dir]","\u8f93\u51fa\u7684\u76ee\u6807\u6587\u4ef6\u5939").option("-m, --mini [boolean]","\u662f\u5426\u6df7\u6dc6\uff08\u4e0d\u4f20\u9ed8\u8ba4\u4f7f\u7528\u7ebf\u4e0a\u914d\u7f6e\uff09").description("\u751f\u6210Bundle").usage("[options] <packagePath>").parse(process.argv),(function(){if((r.args||[]).length<1)return r.outputHelp(),void process.exit(10001);try{(0,require('child_process').execSync)("sed -i -e 's/watch: true/watch: false/' node_modules/react-native/node_modules/metro/src/node-haste/DependencyGraph.js")}catch(e){console.log('Fail to close watch')}var t=p(r.args[0]),g=(0,e.default)(t,2),m=g[0],b=g[1];if(!/^\S+(\.\S+)+$/.test(m)||!i.existsSync(b)||!i.statSync(b).isDirectory())return console.log(n.red("invalid package path: ",m,b)),r.outputHelp(),void process.exit(10002);var f=r.ios?c:u;console.log(b),console.log(n.green("[MIOT]start to build "+f+" bundle for "+m));var h=r.target&&r.target.length?r.target:null,y=h?o.isAbsolute(h)?h:o.join(s,h):o.join(b,"build",f),v=o.join(y,"sourcemap.json"),S=i.readFileSync(o.join(b,"project.json")),j=JSON.parse(S.toString()),x="plain-bundle"!==j.bundle_command,_=x?"ram-bundle":"bundle",q="file-ram-bundle"===j.bundle_command,k=q?"file-ram-bundle":x?"indexed-ram-bundle":"plain-bundle";d(y);var D=o.join(y,"main.bundle");i.existsSync(D)&&i.unlinkSync(D),i.existsSync(v)&&i.unlinkSync(v),(function(){process.argv=["","",_,"--entry-file",o.join("projects",m,"index.js"),"--bundle-output",D,"--assets-dest",y,"--platform",f,"--dev","false","--minify",'false',"--max-workers",1,"--config","build_bundle_config.js","--reset-cache",!1],x&&!q&&process.argv.push("--indexed-ram-bundle");require('react-native/cli').run()})(),process.on("exit",function(e){0===e&&(console.log(n.blue("export the bundle to:"+y)),i.existsSync(D)?(j.sdk_api_level=l,j.version=a,j.platform=f,j.build_time=(new Date).getTime(),j.bundle_type=k,j.bundle_minify=!1,i.writeFileSync(o.join(y,"project.json"),JSON.stringify(j))):(console.log(n.red("failed to export the bundle")),process.exitCode=10003))})})()}catch(e){console.log(e),process.exit(1e4)}